<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Waldhuter - Precios (v7.4)</title>
<style>
:root{font-family:-apple-system,system-ui,Segoe UI,Roboto,Arial,sans-serif}
body{margin:0;padding:16px;line-height:1.25}
h1{font-size:18px;margin:0 0 10px}
.card{border:1px solid #ddd;border-radius:14px;padding:14px;margin:12px 0}
.muted{color:#666;font-size:13px}
label{font-size:13px;color:#333;display:block;margin:10px 0 6px}
input[type=text]{width:100%;font-size:18px;padding:12px;border-radius:12px;border:1px solid #ccc;background:#fff}
button{width:100%;font-size:17px;padding:12px;border-radius:12px;border:0;background:#111;color:#fff;margin-top:10px}
button.secondary{background:#f2f2f2;color:#111;border:1px solid #ddd}
.row{display:flex;gap:10px}
.row>*{flex:1}
.pill{display:inline-block;padding:3px 10px;border-radius:999px;background:#f2f2f2;font-size:12px}
.result-title{font-size:16px;font-weight:800;margin:0 0 6px}
.result-line{font-size:15px;margin:2px 0}
.bad{color:#b00020}
.ok{color:#0a7a2f}
pre{white-space:pre-wrap;word-break:break-word}
</style>
</head>
<body>
<h1>Waldhuter - Precios</h1>
<div class="muted">v7.4: guarda el listado grande en <span class="pill">IndexedDB</span> (no localStorage), así iPhone no se queda “cargando”.</div>

<div class="card">
  <div id="status" class="muted">Cargando…</div>
  <div class="row">
    <button id="updateBtn" type="button">Actualizar lista central</button>
    <button id="clearBtn2" class="secondary" type="button">Borrar cache local</button>
  </div>
  <details style="margin-top:10px;">
    <summary class="muted">Ver diagnóstico</summary>
    <pre id="diag" class="muted"></pre>
  </details>
</div>

<div class="card">
  <label>ISBN-13</label>
  <input id="isbn" type="text" inputmode="numeric" placeholder="Pegá el ISBN (13 dígitos)" />
  <div class="row">
    <button id="buscarBtn" type="button">Buscar</button>
    <button id="clearBtn" class="secondary" type="button">Limpiar</button>
  </div>
  <div id="result" style="margin-top:12px;"></div>
</div>

<script>
const elStatus=document.getElementById("status");
const elDiag=document.getElementById("diag");
const elISBN=document.getElementById("isbn");
const elBuscarBtn=document.getElementById("buscarBtn");
const elClearBtn=document.getElementById("clearBtn");
const elClearBtn2=document.getElementById("clearBtn2");
const elUpdateBtn=document.getElementById("updateBtn");
const elResult=document.getElementById("result");

const diag = { ua: navigator.userAgent, href: location.href, origin: location.origin, online: navigator.onLine, t0: new Date().toISOString() };
function log(k,v){ diag[k]=v; elDiag.textContent = JSON.stringify(diag,null,2); }
window.addEventListener("error",(e)=>log("window_error", String(e.message||e.error||e)));
window.addEventListener("unhandledrejection",(e)=>log("unhandledrejection", String(e.reason||e)));

function setStatus(t, ok=null){
  elStatus.textContent=t;
  elStatus.className="muted"+(ok===true?" ok":ok===false?" bad":"");
}
function normalizeISBN(s){ return (s||"").toString().replace(/[^\dX]/gi,"").trim(); }
function parsePriceToNumber(p){
  let s=String(p||"").trim(); if(!s) return 0;
  s=s.replace(/\s/g,"").replace(/[^0-9.,-]/g,"");
  if(s.includes(".")&&s.includes(",")) s=s.replace(/\./g,"").replace(",", ".");
  else if(s.includes(",")&&!s.includes(".")) s=s.replace(",", ".");
  const n=Number(s); return isFinite(n)?n:0;
}
function fmtMoney(n){ try{return n.toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:2});}catch{return "$"+n;} }

const META_KEY="waldhuter_meta_v74";
const IDB_NAME="waldhuter_v74";
const IDB_STORE="db";

function metaLoad(){ try{ return JSON.parse(localStorage.getItem(META_KEY)||"null"); }catch(e){ log("meta_parse_error", String(e)); return null; } }
function metaSave(m){ localStorage.setItem(META_KEY, JSON.stringify(m)); }

function idbOpen(){
  return new Promise((resolve,reject)=>{
    const req=indexedDB.open(IDB_NAME,1);
    req.onupgradeneeded=()=>{
      const db=req.result;
      if(!db.objectStoreNames.contains(IDB_STORE)) db.createObjectStore(IDB_STORE,{keyPath:"id"});
    };
    req.onsuccess=()=>resolve(req.result);
    req.onerror=()=>reject(req.error);
  });
}
async function idbPut(id,data){
  const db=await idbOpen();
  return new Promise((resolve,reject)=>{
    const tx=db.transaction(IDB_STORE,"readwrite");
    tx.objectStore(IDB_STORE).put({id,data});
    tx.oncomplete=()=>resolve(true);
    tx.onerror=()=>reject(tx.error);
  });
}
async function idbGet(id){
  const db=await idbOpen();
  return new Promise((resolve,reject)=>{
    const tx=db.transaction(IDB_STORE,"readonly");
    const rq=tx.objectStore(IDB_STORE).get(id);
    rq.onsuccess=()=>resolve(rq.result ? rq.result.data : null);
    rq.onerror=()=>reject(rq.error);
  });
}
async function idbClear(){
  const db=await idbOpen();
  return new Promise((resolve,reject)=>{
    const tx=db.transaction(IDB_STORE,"readwrite");
    tx.objectStore(IDB_STORE).clear();
    tx.oncomplete=()=>resolve(true);
    tx.onerror=()=>reject(tx.error);
  });
}

async function fetchJSON(url){
  const r=await fetch(url,{cache:"no-store"});
  if(!r.ok) throw new Error("HTTP "+r.status+" en "+url);
  return await r.json();
}

let DB=null;

async function loadFromCache(){
  try{
    const db=await idbGet("central");
    const meta=metaLoad();
    if(db && meta){
      DB=db;
      setStatus("Lista desde cache ✅ ("+Number(meta.count||0).toLocaleString("es-AR")+" ISBN) · ver "+meta.version, true);
      return true;
    }
  }catch(e){ log("load_cache_error", String(e)); }
  return false;
}

async function updateCentral(force=false){
  if(!navigator.onLine){ setStatus("Sin internet: uso cache si existe.", null); return false; }
  setStatus(force?"Descargando lista…":"Verificando actualización…", null);
  const remote = await fetchJSON("./version.json?v="+Date.now());
  const local = metaLoad();
  const changed = force || !local || local.version !== remote.version;
  if(!changed){
    setStatus("Lista al día ✅ ("+Number(remote.count||0).toLocaleString("es-AR")+" ISBN)", true);
    return false;
  }
  setStatus("Bajando libros.json…", null);
  const db = await fetchJSON("./libros.json?v="+Date.now());
  setStatus("Guardando en el teléfono…", null);
  await idbPut("central", db);
  metaSave({version: remote.version, count: remote.count||Object.keys(db).length, updatedAt: new Date().toISOString()});
  DB=db;
  setStatus("Lista actualizada ✅ ("+Number(Object.keys(db).length).toLocaleString("es-AR")+" ISBN)", true);
  return true;
}

function renderNotFound(code){ return `<div class="card"><div class="result-title bad">No lo encontré</div><div class="result-line"><b>ISBN:</b> ${code}</div></div>`; }
function renderRow(code,row){
  const price=parsePriceToNumber(row.p);
  const s=(row.s??"").toString().trim();
  const a=(row.a??"").toString().trim();
  const ed=(row.e??"").toString().trim();
  return `<div class="card"><div class="result-title">${row.t||"(sin título)"}</div>
    <div class="result-line"><b>ISBN:</b> ${code}</div>
    <div class="result-line"><b>PVP:</b> ${fmtMoney(price)}</div>
    ${s?`<div class="result-line"><b>Stock:</b> ${s}</div>`:""}
    ${a?`<div class="result-line"><b>Autor:</b> ${a}</div>`:""}
    ${ed?`<div class="result-line"><b>Editorial:</b> ${ed}</div>`:""}
  </div>`;
}

function lookup(){
  const code=normalizeISBN(elISBN.value);
  if(!code){ elResult.innerHTML=""; return; }
  if(!DB){
    elResult.innerHTML=`<div class="card"><div class="result-title bad">No hay lista cargada</div><div class="muted">Tocá “Actualizar lista central”.</div></div>`;
    return;
  }
  const row=DB[code];
  if(!row){ elResult.innerHTML=renderNotFound(code); return; }
  elResult.innerHTML=renderRow(code,row);
}
elBuscarBtn.onclick=lookup;
elClearBtn.onclick=()=>{ elISBN.value=""; elResult.innerHTML=""; elISBN.focus(); };
elISBN.addEventListener("keydown",(e)=>{ if(e.key==="Enter") lookup(); });

elUpdateBtn.onclick=()=>updateCentral(true).catch(e=>{ setStatus("Error al actualizar: "+e.message, false); log("update_error", String(e)); });
elClearBtn2.onclick=async()=>{
  try{
    localStorage.removeItem(META_KEY);
    await idbClear();
    DB=null;
    setStatus("Cache borrado. Tocá 'Actualizar lista central'.", null);
    elResult.innerHTML="";
  }catch(e){
    setStatus("Error borrando cache: "+e.message, false);
    log("clear_error", String(e));
  }
};

(async function boot(){
  if(location.protocol==="file:"){
    setStatus("Abriste desde Archivos (file://). Abrí desde GitHub Pages (https://...).", false);
    log("protocol", location.protocol);
    return;
  }
  if(!window.indexedDB){
    setStatus("Este navegador no soporta IndexedDB (necesario).", false);
    log("indexeddb", false);
    return;
  }
  const ok = await loadFromCache();
  if(!ok) setStatus("No hay cache. Tocá 'Actualizar lista central'.", null);
  updateCentral(false).catch(e=>log("bg_update_error", String(e)));
  log("boot_ok", true);
})();
</script>
</body>
</html>
