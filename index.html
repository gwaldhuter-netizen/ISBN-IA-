<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Waldhuter - Precios (v7.1)</title>
<style>
:root{font-family:-apple-system,system-ui,Segoe UI,Roboto,Arial,sans-serif}
body{margin:0;padding:16px;line-height:1.25}
h1{font-size:18px;margin:0 0 10px}
.card{border:1px solid #ddd;border-radius:14px;padding:14px;margin:12px 0}
.muted{color:#666;font-size:13px}
label{font-size:13px;color:#333;display:block;margin:10px 0 6px}
input[type=text],select{width:100%;font-size:18px;padding:12px;border-radius:12px;border:1px solid #ccc;background:#fff}
input[type=file]{width:100%}
button{width:100%;font-size:17px;padding:12px;border-radius:12px;border:0;background:#111;color:#fff;margin-top:10px}
button.secondary{background:#f2f2f2;color:#111;border:1px solid #ddd}
button.danger{background:#b00020}
.row{display:flex;gap:10px}
.row>*{flex:1}
.pill{display:inline-block;padding:3px 10px;border-radius:999px;background:#f2f2f2;font-size:12px}
.result-title{font-size:16px;font-weight:800;margin:0 0 6px}
.result-line{font-size:15px;margin:2px 0}
.ok{color:#0a7a2f}
.bad{color:#b00020}
details>summary{cursor:pointer}
.tabs{display:flex;gap:8px;margin:10px 0}
.tab{flex:1;text-align:center;padding:10px;border-radius:12px;border:1px solid #ddd;background:#fff;font-weight:700}
.tab.active{background:#111;color:#fff;border:0}
.cart-item{padding:10px 0;border-top:1px solid #eee}
.cart-title{font-weight:800;font-size:14px;margin:0 0 4px}
.cart-sub{font-size:13px;color:#444;margin:0}
.cart-actions{display:flex;gap:10px;margin-top:10px;align-items:center;flex-wrap:wrap}
.iconbtn{width:46px;height:46px;border-radius:999px;border:0;font-size:22px;line-height:46px;text-align:center}
.iconbtn.plus{background:#111;color:#fff}
.iconbtn.minus{background:#f2f2f2;color:#111;border:1px solid #ddd}
.iconbtn.del{background:#b00020;color:#fff;width:auto;padding:0 14px;font-size:14px;border-radius:12px;height:46px;line-height:46px}
.qty{min-width:38px;text-align:center;font-weight:900;font-size:18px}
#modalBack{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;padding:16px}
#modal{width:100%;max-width:520px;background:#fff;border-radius:16px;padding:14px}
.hist-item{padding:10px 0;border-top:1px solid #eee}
.small{font-size:12px;color:#666}
pre{white-space:pre-wrap;word-break:break-word}
</style>
</head>
<body>
<h1>Waldhuter - Precios</h1>
<div class="muted">v7.1: igual que v7 pero con diagnóstico + fallback si Safari bloquea IndexedDB. (Abrir siempre desde GitHub Pages, no desde “Archivos”).</div>

<div class="tabs">
  <div id="tabBuscar" class="tab active">Buscar</div>
  <div id="tabCaja" class="tab">Caja</div>
  <div id="tabHist" class="tab">Historial</div>
</div>

<div class="card">
  <div id="status" class="muted">Cargando…</div>
  <div id="diag" class="muted" style="margin-top:6px;"></div>
  <div class="row">
    <button id="checkBtn" type="button">Buscar actualización</button>
    <button id="forceBtn" class="secondary" type="button">Forzar descargar lista central</button>
  </div>

  <div class="muted" style="margin-top:10px;">Lista activa:</div>
  <select id="listSelect"></select>

  <details style="margin-top:10px;">
    <summary class="muted">Importar CSV como lista nueva (local)</summary>
    <div class="muted">Si tu Safari bloquea almacenamiento (modo privado), esta función puede no estar disponible.</div>
    <label>Nombre de lista</label>
    <input id="listName" type="text" placeholder="ej: Promo Feria / Lista Marzo" />
    <input id="csvFile" type="file" accept=".csv,text/csv" />
    <button id="importBtn" class="secondary" type="button">Importar y guardar lista</button>
    <div id="csvMsg" class="muted" style="margin-top:8px;"></div>
  </details>

  <details style="margin-top:10px;">
    <summary class="muted">Ver diagnóstico</summary>
    <pre id="diagPre" class="muted"></pre>
  </details>
</div>

<div id="viewBuscar">
  <div class="card">
    <label>ISBN-13</label>
    <input id="isbn" type="text" inputmode="numeric" placeholder="Pegá el ISBN (13 dígitos)" />
    <div class="row">
      <button id="buscarBtn" type="button">Buscar</button>
      <button id="clearBtn" class="secondary" type="button">Limpiar</button>
    </div>
    <div id="result" style="margin-top:12px;"></div>
  </div>
</div>

<div id="viewCaja" style="display:none;">
  <div class="card">
    <div class="result-title">Cuenta</div>
    <div class="muted">Total: <span class="pill" id="totalPill">$0</span></div>
    <div id="cart"></div>
    <div class="row">
      <button id="saveSaleBtn" type="button">Guardar venta en historial</button>
      <button id="resetCartBtn" class="secondary" type="button">Vaciar cuenta</button>
    </div>
    <button id="shareBtn" class="secondary" type="button">Compartir (copiar texto)</button>
  </div>
</div>

<div id="viewHist" style="display:none;">
  <div class="card">
    <div class="result-title">Historial</div>
    <div class="muted">Se guarda en el teléfono.</div>
    <div class="row">
      <button id="clearHistBtn" class="secondary" type="button">Borrar todo</button>
      <button id="exportHistBtn" class="secondary" type="button">Exportar (copiar)</button>
    </div>
    <div id="hist"></div>
  </div>
</div>

<div id="modalBack">
  <div id="modal">
    <div class="result-title">¿Agregar a la cuenta?</div>
    <div id="modalBody" class="muted" style="margin-top:8px;"></div>
    <div class="row" style="margin-top:12px;">
      <button id="modalYes" type="button">Sí, agregar</button>
      <button id="modalNo" class="secondary" type="button">No</button>
    </div>
  </div>
</div>

<script>
/* ===== diagnostics ===== */
const diag = { t0: Date.now() };
function logDiag(k,v){ diag[k]=v; try{ document.getElementById("diagPre").textContent = JSON.stringify(diag,null,2);}catch{} }
window.addEventListener("error",(e)=>{ logDiag("window_error", String(e.message||e.error||e)); });
window.addEventListener("unhandledrejection",(e)=>{ logDiag("unhandledrejection", String(e.reason||e)); });

/* ===== Tabs ===== */
const tabBuscar=document.getElementById("tabBuscar");
const tabCaja=document.getElementById("tabCaja");
const tabHist=document.getElementById("tabHist");
const viewBuscar=document.getElementById("viewBuscar");
const viewCaja=document.getElementById("viewCaja");
const viewHist=document.getElementById("viewHist");
function setTab(which){
  for(const [t,v] of [[tabBuscar,viewBuscar],[tabCaja,viewCaja],[tabHist,viewHist]]){
    const active=t.id===which;
    t.classList.toggle("active",active);
    v.style.display=active?"":"none";
  }
}
tabBuscar.onclick=()=>setTab("tabBuscar");
tabCaja.onclick=()=>{setTab("tabCaja"); renderCart();};
tabHist.onclick=()=>{setTab("tabHist"); renderHist();};

/* ===== Helpers ===== */
const elStatus=document.getElementById("status");
const elDiagLine=document.getElementById("diag");
const elListSelect=document.getElementById("listSelect");
const elCheckBtn=document.getElementById("checkBtn");
const elForceBtn=document.getElementById("forceBtn");
const elListName=document.getElementById("listName");
const elCsvFile=document.getElementById("csvFile");
const elImportBtn=document.getElementById("importBtn");
const elCsvMsg=document.getElementById("csvMsg");
const elISBN=document.getElementById("isbn");
const elBuscarBtn=document.getElementById("buscarBtn");
const elClearBtn=document.getElementById("clearBtn");
const elResult=document.getElementById("result");
const elCart=document.getElementById("cart");
const elTotal=document.getElementById("totalPill");
const elResetCart=document.getElementById("resetCartBtn");
const elSaveSale=document.getElementById("saveSaleBtn");
const elShare=document.getElementById("shareBtn");
const elHist=document.getElementById("hist");
const elClearHist=document.getElementById("clearHistBtn");
const elExportHist=document.getElementById("exportHistBtn");
const modalBack=document.getElementById("modalBack");
const modalBody=document.getElementById("modalBody");
const modalYes=document.getElementById("modalYes");
const modalNo=document.getElementById("modalNo");

function setStatus(t,cls="muted"){ elStatus.className=cls; elStatus.textContent=t; }
function setCsvMsg(t,cls="muted"){ elCsvMsg.className=cls; elCsvMsg.textContent=t; }
function normalizeISBN(s){ return (s||"").toString().replace(/[^\dX]/gi,"").trim(); }
function parsePriceToNumber(p){
  let s=String(p||"").trim(); if(!s) return 0;
  s=s.replace(/\s/g,"").replace(/[^0-9.,-]/g,"");
  if(s.includes(".")&&s.includes(",")) s=s.replace(/\./g,"").replace(",", ".");
  else if(s.includes(",")&&!s.includes(".")) s=s.replace(",", ".");
  const n=Number(s); return isFinite(n)?n:0;
}
function fmtMoney(n){ try{return n.toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:2});}catch{return "$"+n;} }
function nowISO(){ try{return new Date().toISOString();}catch{return ""; } }

/* ===== Storage + fallback store ===== */
const STORAGE_ACTIVE_LIST="waldhuter_active_list_v71";
const STORAGE_CART="waldhuter_cart_v71";
const STORAGE_HIST="waldhuter_hist_v71";
const STORAGE_CENTER_META="waldhuter_center_meta_v71";
const FALLBACK_ALL_LISTS="waldhuter_lists_fallback_v71"; // only if IndexedDB fails

let STORE_MODE="idb"; // or "fallback"
logDiag("userAgent", navigator.userAgent);
logDiag("onLine", navigator.onLine);
logDiag("origin", location.origin);
logDiag("href", location.href);

function getActiveListId(){ return localStorage.getItem(STORAGE_ACTIVE_LIST) || "central"; }
function setActiveListId(id){ localStorage.setItem(STORAGE_ACTIVE_LIST, id); }

/* ===== IndexedDB wrapper with fallback ===== */
const IDB_NAME="waldhuter_v71", IDB_STORE="lists";
function idbOpen(){
  return new Promise((resolve,reject)=>{
    try{
      const req=indexedDB.open(IDB_NAME,1);
      req.onupgradeneeded=()=>{
        const db=req.result;
        if(!db.objectStoreNames.contains(IDB_STORE)) db.createObjectStore(IDB_STORE,{keyPath:"id"});
      };
      req.onsuccess=()=>resolve(req.result);
      req.onerror=()=>reject(req.error);
    }catch(e){ reject(e); }
  });
}
async function idbPutList(listObj){
  const db=await idbOpen();
  return new Promise((resolve,reject)=>{
    const tx=db.transaction(IDB_STORE,"readwrite");
    tx.objectStore(IDB_STORE).put(listObj);
    tx.oncomplete=()=>resolve(true);
    tx.onerror=()=>reject(tx.error);
  });
}
async function idbGetList(id){
  const db=await idbOpen();
  return new Promise((resolve,reject)=>{
    const tx=db.transaction(IDB_STORE,"readonly");
    const req=tx.objectStore(IDB_STORE).get(id);
    req.onsuccess=()=>resolve(req.result||null);
    req.onerror=()=>reject(req.error);
  });
}
async function idbGetAllLists(){
  const db=await idbOpen();
  return new Promise((resolve,reject)=>{
    const tx=db.transaction(IDB_STORE,"readonly");
    const req=tx.objectStore(IDB_STORE).getAll();
    req.onsuccess=()=>resolve(req.result||[]);
    req.onerror=()=>reject(req.error);
  });
}

/* Fallback store in localStorage (central only recommended) */
function fbLoadAll(){ try{ return JSON.parse(localStorage.getItem(FALLBACK_ALL_LISTS)||"[]")||[]; }catch{ return []; } }
function fbSaveAll(arr){ localStorage.setItem(FALLBACK_ALL_LISTS, JSON.stringify(arr)); }
async function storeGetAll(){
  if(STORE_MODE==="fallback") return fbLoadAll();
  try{ return await idbGetAllLists(); }catch(e){
    STORE_MODE="fallback"; logDiag("idb_failed_getall", String(e)); elDiagLine.textContent="⚠️ Safari bloqueó IndexedDB. Uso modo fallback (limitado).";
    return fbLoadAll();
  }
}
async function storeGet(id){
  if(STORE_MODE==="fallback") return fbLoadAll().find(x=>x.id===id)||null;
  try{ return await idbGetList(id); }catch(e){
    STORE_MODE="fallback"; logDiag("idb_failed_get", String(e)); elDiagLine.textContent="⚠️ Safari bloqueó IndexedDB. Uso modo fallback (limitado).";
    return fbLoadAll().find(x=>x.id===id)||null;
  }
}
async function storePut(obj){
  if(STORE_MODE==="fallback"){
    const all=fbLoadAll().filter(x=>x.id!==obj.id);
    all.push(obj); fbSaveAll(all); return true;
  }
  try{ return await idbPutList(obj); }catch(e){
    STORE_MODE="fallback"; logDiag("idb_failed_put", String(e)); elDiagLine.textContent="⚠️ Safari bloqueó IndexedDB. Uso modo fallback (limitado).";
    const all=fbLoadAll().filter(x=>x.id!==obj.id);
    all.push(obj); fbSaveAll(all); return true;
  }
}

/* ===== Central update ===== */
async function fetchJSON(url){
  const res=await fetch(url,{cache:"no-store"});
  if(!res.ok) throw new Error("HTTP "+res.status);
  return await res.json();
}
function getCenterMeta(){ try{ return JSON.parse(localStorage.getItem(STORAGE_CENTER_META)||"null"); }catch{ return null; } }
function setCenterMeta(m){ localStorage.setItem(STORAGE_CENTER_META, JSON.stringify(m)); }

async function checkCentralUpdate(force=false){
  if(!navigator.onLine){ setStatus("Sin internet: uso lista guardada.","muted"); return false; }
  setStatus(force?"Descargando lista central…":"Verificando actualización…");
  const remote = await fetchJSON("./version.json?v="+Date.now());
  const local = getCenterMeta();
  const changed = force || !local || local.version !== remote.version;
  if(!changed){ setStatus(`Central al día ✅ (${Number(remote.count||0).toLocaleString("es-AR")} ISBN)`, "muted ok"); return false; }
  const libros = await fetchJSON("./libros.json?v="+Date.now());
  await storePut({id:"central", name:"Central", source:"central", version:remote.version, count:remote.count||Object.keys(libros).length, updatedAt:nowISO(), data:libros});
  setCenterMeta({version:remote.version, count:remote.count||Object.keys(libros).length, updatedAt:nowISO()});
  setStatus(`Central actualizada ✅ (${Number(remote.count||Object.keys(libros).length).toLocaleString("es-AR")} ISBN)`, "muted ok");
  return true;
}

/* ===== Lists ===== */
let ACTIVE_LIST_ID=null, DB=null, DB_META=null;

async function ensureCentralExists(){
  const c = await storeGet("central");
  if(c) return;
  if(navigator.onLine){ try{ await checkCentralUpdate(true); }catch(e){ logDiag("central_first_download_failed", String(e)); } }
  const cc = await storeGet("central");
  if(!cc) await storePut({id:"central", name:"Central", source:"central", version:null, count:0, updatedAt:nowISO(), data:{}});
}
async function refreshListSelect(){
  const lists = await storeGetAll();
  lists.sort((a,b)=>(a.name||"").localeCompare(b.name||""));
  const active = getActiveListId();
  elListSelect.innerHTML="";
  for(const l of lists){
    const opt=document.createElement("option");
    opt.value=l.id;
    const tag=l.source==="central"?" (central)":" (local)";
    const meta=l.count?` — ${Number(l.count).toLocaleString("es-AR")} ISBN`:"";
    opt.textContent=(l.name||l.id)+tag+meta;
    if(l.id===active) opt.selected=true;
    elListSelect.appendChild(opt);
  }
  if(!lists.some(l=>l.id===active)){
    setActiveListId("central");
    if(elListSelect.options.length) elListSelect.value="central";
  }
}
async function loadActiveList(){
  ACTIVE_LIST_ID=getActiveListId();
  const list=await storeGet(ACTIVE_LIST_ID);
  if(!list){ DB=null; DB_META=null; setStatus("No encontré la lista activa.","muted bad"); return; }
  DB=list.data||{};
  DB_META={id:list.id,name:list.name,source:list.source,version:list.version,count:list.count||Object.keys(DB).length,updatedAt:list.updatedAt};
  const src=list.source==="central"?"central":"local";
  const ver=list.version?` · ver ${list.version}`:"";
  setStatus(`Lista activa: ${list.name} ✅ (${Number(DB_META.count).toLocaleString("es-AR")} ISBN) · ${src}${ver}`, "muted ok");
}
elListSelect.onchange=async()=>{ setActiveListId(elListSelect.value); await loadActiveList(); elISBN.focus(); };

/* ===== CSV import ===== */
function stripBOM(s){return (s||"").replace(/^\uFEFF/,"");}
function stripAccents(s){return (s||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"");}
function normHeader(s){return stripAccents(stripBOM(String(s||"").trim().toLowerCase()));}
function splitCSVLine(line,delim){
  const out=[]; let cur=""; let inQ=false;
  for(let i=0;i<line.length;i++){
    const ch=line[i];
    if(ch==='"'){ if(inQ&&line[i+1]==='"'){cur+='"';i++;} else inQ=!inQ; }
    else if(ch===delim&&!inQ){ out.push(cur); cur=""; }
    else cur+=ch;
  }
  out.push(cur);
  return out.map(v=>v.trim());
}
function guessDelimiter(line){
  const cands=[";",",","\t"]; let best=";", bestCount=-1;
  for(const d of cands){ const c=line.split(d).length-1; if(c>bestCount){bestCount=c;best=d;} }
  return best;
}
function parseCSVToDB(text){
  const lines=text.replace(/\r\n/g,"\n").replace(/\r/g,"\n").split("\n");
  let headerIdx=-1,delim=";",header=null;
  for(let i=0;i<lines.length;i++){
    const raw=lines[i]; if(!raw||!raw.trim()) continue;
    const d=guessDelimiter(raw);
    const cols=splitCSVLine(raw,d);
    const low=cols.map(normHeader);
    const hasCodigo=low.includes("codigo")||low.includes("isbn");
    const hasPvp=low.includes("pvp")||low.includes("precio");
    if(hasCodigo&&hasPvp&&cols.length>=4){headerIdx=i;delim=d;header=cols;break;}
  }
  if(headerIdx===-1) throw new Error("No encontré encabezados (Código/ISBN y PVP/Precio).");
  const idx={}; header.forEach((h,i)=>idx[normHeader(h)]=i);
  const pick=(names)=>{ for(const n of names){ const k=normHeader(n); if(idx[k]!==undefined) return idx[k]; } return undefined; };
  const iCodigo=pick(["Código","Codigo","ISBN"]);
  const iTitulo=pick(["Título","Titulo"]);
  const iAutor=pick(["Autor"]);
  const iEditorial=pick(["Editorial"]);
  const iPvp=pick(["PVP","Precio"]);
  const iStock=pick(["Stock Físico","Stock Fisico","Stock"]);
  if(iCodigo===undefined||iPvp===undefined) throw new Error("Header ok, pero no pude ubicar Código y PVP.");
  const obj={}; let count=0;
  for(let i=headerIdx+1;i<lines.length;i++){
    const raw=lines[i]; if(!raw||!raw.trim()) continue;
    const cols=splitCSVLine(raw,delim);
    const code=normalizeISBN(cols[iCodigo]??"");
    if(!code||code.toLowerCase()==="codigo") continue;
    obj[code]={t:iTitulo===undefined?"":(cols[iTitulo]??""),a:iAutor===undefined?"":(cols[iAutor]??""),e:iEditorial===undefined?"":(cols[iEditorial]??""),p:(cols[iPvp]??""),s:iStock===undefined?"":(cols[iStock]??"")};
    count++;
  }
  return {obj,count};
}
elImportBtn.onclick=async()=>{
  const name=(elListName.value||"").trim();
  const f=elCsvFile.files&&elCsvFile.files[0];
  if(!name){setCsvMsg("Poné un nombre para la lista.","muted bad");return;}
  if(!f){setCsvMsg("Elegí un CSV.","muted bad");return;}
  if(STORE_MODE==="fallback"){ setCsvMsg("Safari bloqueó almacenamiento avanzado (modo fallback). Probá salir de modo privado.", "muted bad"); return; }
  setCsvMsg("Importando…");
  try{
    const text=await f.text();
    const {obj,count}=parseCSVToDB(text);
    const id="local_"+Date.now();
    await storePut({id,name,source:"local",version:null,count,updatedAt:nowISO(),data:obj});
    setCsvMsg(`Lista guardada ✅ (${Number(count).toLocaleString("es-AR")} ISBN)`, "muted ok");
    await refreshListSelect();
    elListSelect.value=id; setActiveListId(id); await loadActiveList();
  }catch(e){ setCsvMsg("Error: "+e.message, "muted bad"); }
};

/* ===== Lookup + modal add ===== */
function renderRow(code,row){
  const price=parsePriceToNumber(row.p);
  const s=(row.s??"").toString().trim();
  const a=(row.a??"").toString().trim();
  const ed=(row.e??"").toString().trim();
  return `<div class="card"><div class="result-title">${row.t||"(sin título)"}</div>
    <div class="result-line"><b>ISBN:</b> ${code}</div>
    <div class="result-line"><b>PVP:</b> ${fmtMoney(price)}</div>
    ${s?`<div class="result-line"><b>Stock:</b> ${s}</div>`:""}
    ${a?`<div class="result-line"><b>Autor:</b> ${a}</div>`:""}
    ${ed?`<div class="result-line"><b>Editorial:</b> ${ed}</div>`:""}
  </div>`;
}
function renderNotFound(code){return `<div class="card"><div class="result-title bad">No lo encontré</div><div class="result-line"><b>ISBN:</b> ${code}</div></div>`;}
function openModal(found){
  modalBody.innerHTML=`<div><b>${found.row.t||"(sin título)"}</b></div>
    <div class="muted" style="margin-top:6px;">${fmtMoney(found.price)} · ISBN ${found.code}</div>
    <div class="muted" style="margin-top:6px;">¿Agregar a la cuenta?</div>`;
  modalBack.style.display="flex";
  window.__LAST_FOUND=found;
}
function closeModal(){modalBack.style.display="none"; window.__LAST_FOUND=null;}
modalNo.onclick=()=>{closeModal(); elISBN.select(); elISBN.focus();};
modalYes.onclick=()=>{
  const f=window.__LAST_FOUND; if(!f){closeModal();return;}
  addToCart(f.code,f.row,f.price);
  closeModal();
  elISBN.value=""; elResult.innerHTML=""; elISBN.focus();
  setTab("tabCaja");
};
function lookup(){
  const code=normalizeISBN(elISBN.value);
  if(!code){elResult.innerHTML="";return;}
  if(!DB){elResult.innerHTML=`<div class="card"><div class="result-title">Cargando lista…</div></div>`;return;}
  const row=DB[code];
  if(!row){elResult.innerHTML=renderNotFound(code);return;}
  elResult.innerHTML=renderRow(code,row);
  openModal({code,row,price:parsePriceToNumber(row.p)});
}
elBuscarBtn.onclick=lookup;
elClearBtn.onclick=()=>{elISBN.value=""; elResult.innerHTML=""; elISBN.focus();};
elISBN.addEventListener("keydown",(e)=>{if(e.key==="Enter") lookup();});

/* ===== Cart ===== */
function loadCart(){try{return JSON.parse(localStorage.getItem(STORAGE_CART)||"{}")||{};}catch{return {};}} 
function saveCart(c){localStorage.setItem(STORAGE_CART,JSON.stringify(c));}
function cartTotal(c){let t=0; for(const k of Object.keys(c)) t+=(c[k].price||0)*(c[k].qty||0); return t;}
function addToCart(code,row,price){
  const c=loadCart();
  if(!c[code]) c[code]={title:row.t||"",price:price||0,qty:1};
  else c[code].qty=(c[code].qty||0)+1;
  saveCart(c); renderCart();
}
function renderCart(){
  const c=loadCart(); const codes=Object.keys(c);
  if(!codes.length){elCart.innerHTML='<div class="muted" style="margin-top:10px;">Sin items.</div>'; elTotal.textContent=fmtMoney(0); return;}
  let html="";
  for(const code of codes){
    const it=c[code];
    html+=`<div class="cart-item">
      <p class="cart-title">${it.title||"(sin título)"}</p>
      <p class="cart-sub">ISBN: ${code} · ${fmtMoney(it.price||0)}</p>
      <div class="cart-actions">
        <button class="iconbtn minus" data-act="dec" data-code="${code}">−</button>
        <span class="qty">${it.qty||0}</span>
        <button class="iconbtn plus" data-act="inc" data-code="${code}">+</button>
        <button class="iconbtn del" data-act="del" data-code="${code}">Quitar</button>
      </div>
    </div>`;
  }
  elCart.innerHTML=html;
  elTotal.textContent=fmtMoney(cartTotal(c));
}
elCart.addEventListener("click",(e)=>{
  const b=e.target.closest("button"); if(!b) return;
  const act=b.dataset.act, code=b.dataset.code;
  const c=loadCart(); if(!c[code]) return;
  if(act==="inc") c[code].qty=(c[code].qty||0)+1;
  if(act==="dec") c[code].qty=Math.max(1,(c[code].qty||1)-1);
  if(act==="del") delete c[code];
  saveCart(c); renderCart();
});
elResetCart.onclick=()=>{localStorage.removeItem(STORAGE_CART); renderCart();};
function cartToText(cart){
  const lines=[]; let total=0;
  for(const code of Object.keys(cart)){
    const it=cart[code]; const sub=(it.price||0)*(it.qty||0); total+=sub;
    lines.push(`${it.title} x${it.qty} — ${fmtMoney(sub)} (ISBN ${code})`);
  }
  lines.push(`TOTAL: ${fmtMoney(total)}`);
  return lines.join("\n");
}
elShare.onclick=async()=>{
  const cart=loadCart(); const txt=cartToText(cart);
  try{ await navigator.clipboard.writeText(txt); alert("Copiado ✅ (pegalo en WhatsApp)"); }
  catch{ prompt("Copiá este texto:", txt); }
};

/* ===== Hist ===== */
function loadHist(){try{return JSON.parse(localStorage.getItem(STORAGE_HIST)||"[]")||[];}catch{return [];}}
function saveHist(arr){localStorage.setItem(STORAGE_HIST,JSON.stringify(arr));}
function saveSale(){
  const cart=loadCart(); if(!Object.keys(cart).length){alert("La cuenta está vacía.");return;}
  const sale={id:"sale_"+Date.now(),at:nowISO(),listId:ACTIVE_LIST_ID,listName:(DB_META&&DB_META.name)?DB_META.name:ACTIVE_LIST_ID,items:cart,total:cartTotal(cart)};
  const hist=loadHist(); hist.unshift(sale); saveHist(hist);
  localStorage.removeItem(STORAGE_CART);
  renderCart(); renderHist();
  alert("Venta guardada ✅");
}
elSaveSale.onclick=saveSale;
function renderHist(){
  const hist=loadHist();
  if(!hist.length){elHist.innerHTML='<div class="muted" style="margin-top:10px;">Sin ventas guardadas.</div>';return;}
  let html="";
  for(const s of hist){
    const when=s.at?new Date(s.at).toLocaleString("es-AR"):"";
    const count=Object.keys(s.items||{}).length;
    html+=`<div class="hist-item">
      <div style="font-weight:800">${fmtMoney(s.total||0)} <span class="small">(${count} ítems)</span></div>
      <div class="small">${when} · Lista: ${s.listName||""}</div>
      <div class="row" style="margin-top:8px;">
        <button class="secondary" data-hact="copy" data-hid="${s.id}">Copiar</button>
        <button class="danger" data-hact="del" data-hid="${s.id}">Borrar</button>
      </div>
    </div>`;
  }
  elHist.innerHTML=html;
}
elHist.addEventListener("click",async(e)=>{
  const b=e.target.closest("button"); if(!b) return;
  const act=b.dataset.hact, id=b.dataset.hid;
  const hist=loadHist(); const s=hist.find(x=>x.id===id); if(!s) return;
  if(act==="del"){ saveHist(hist.filter(x=>x.id!==id)); renderHist(); }
  if(act==="copy"){
    const txt=cartToText(s.items||{});
    try{ await navigator.clipboard.writeText(txt); alert("Copiado ✅"); }
    catch{ prompt("Copiá:", txt); }
  }
});
elClearHist.onclick=()=>{if(confirm("¿Borrar todo el historial?")){localStorage.removeItem(STORAGE_HIST); renderHist();}};
elExportHist.onclick=async()=>{
  const hist=loadHist(); const lines=[];
  for(const s of hist){
    const when=s.at?new Date(s.at).toLocaleString("es-AR"):"";
    lines.push(`VENTA ${when} — ${fmtMoney(s.total||0)} — Lista: ${s.listName||""}`);
    lines.push(cartToText(s.items||{}));
    lines.push("----");
  }
  const txt=lines.join("\n");
  try{ await navigator.clipboard.writeText(txt); alert("Historial copiado ✅"); }
  catch{ prompt("Copiá:", txt); }
};

/* ===== Update buttons ===== */
elCheckBtn.onclick=async()=>{ try{ await checkCentralUpdate(false);}catch(e){ setStatus("No pude verificar: "+e.message,"muted bad"); logDiag("check_error", String(e)); } await refreshListSelect(); await loadActiveList(); };
elForceBtn.onclick=async()=>{ try{ await checkCentralUpdate(true);}catch(e){ setStatus("No pude descargar: "+e.message,"muted bad"); logDiag("force_error", String(e)); } await refreshListSelect(); await loadActiveList(); };

/* ===== Boot ===== */
(async function boot(){
  // Biggest real-world cause of "no funciona": opening index.html from Files (file://) or private mode.
  if(location.protocol === "file:"){
    setStatus("Abriste desde Archivos (file://). Esto rompe la carga. Abrí desde tu GitHub Pages (https://...).", "muted bad");
    logDiag("protocol_issue", location.protocol);
    return;
  }
  logDiag("indexedDB_exists", !!window.indexedDB);
  await ensureCentralExists();
  await refreshListSelect();
  // Try background update
  if(navigator.onLine){ checkCentralUpdate(false).then(async()=>{ await refreshListSelect(); await loadActiveList(); }).catch(e=>logDiag("bg_update_error", String(e))); }
  await loadActiveList();
  renderCart(); renderHist();
  setStatus(elStatus.textContent + (STORE_MODE==="fallback" ? " · (modo fallback)" : ""), elStatus.className);
})();
</script>
</body>
</html>
